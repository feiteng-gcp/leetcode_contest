<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
 <TITLE>380_megaspazz.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script type="text/javascript">
  <!--
   function ZweiFrames(URL1,F1,URL2,F2)
   {
    parent.frames[F1].location.href=URL1;
    parent.frames[F2].location.href=URL2;
   }
  //-->
  </script>
</HEAD>
<BODY BGCOLOR="#ffffff" style="margin-left:25">
<HR>
<H3><CENTER>380_megaspazz.java</CENTER></H3><HR>
<PRE>
/**
 * Definition for a binary tree node.
 * public class TreeNode {
 *     int val;
 *     TreeNode left;
 *     TreeNode right;
 *     TreeNode(int x) { val = x; }
 * }
 */
class Solution {
    public int distributeCoins(TreeNode root) {
        DataMap dm = new DataMap();
        dataDfs(root, null, dm);
        ArrayList&lt;TreeNode&gt; nodes = new ArrayList&lt;&gt;(dm.keySet());
        Collections.sort(nodes, new Comparator&lt;TreeNode&gt;() {
            @Override
            public int compare(TreeNode lhs, TreeNode rhs) {
                return Integer.compare(dm.get(rhs).depth, dm.get(lhs).depth);
            }
        });
        for (TreeNode u : nodes) {
            Data d = dm.getData(u);
            // System.out.format(&quot;val = %d, depth  %d, size = %d, valSum = %d\n&quot;, u.val, d.depth, d.size, d.valSum);
        }
        for (TreeNode u : nodes) {
            Data d = dm.getData(u);
            if (d.valSum &gt; d.size) {
                int extra = Math.max(0, d.valSum - d.size);
                // System.out.format(&quot;depth = %d, valSum = %d, val = %d, size = %d, extra = %d\n&quot;, d.depth, d.valSum, u.val, d.size, extra);
                TreeNode p = d.parent;
                if (p != null) {
                    dm.total += extra;
                    p.val += extra;
                    u.val -= extra;
                    d.valSum -= extra;
                    // dm.getData(p).valSum += extra;
                }
            }
        }
        System.out.println(dm.total);
        for (TreeNode u : nodes) {
            if (u.val == 0) {
                stealParent(u, dm);
            }
        }
        return dm.total;
    }
    
    public void stealParent(TreeNode u, DataMap dm) {
        TreeNode init = u;
        int d = 0;
        while (u.val &lt;= 1) {
            ++d;
            u = dm.getData(u).parent;
        }
        --u.val;
        ++init.val;
        dm.total += d;
    }
    
    public void bfsSteal(TreeNode init, DataMap dm) {
        HashSet&lt;TreeNode&gt; seen = new HashSet&lt;&gt;();
        Queue&lt;TreeNode&gt; q = new ArrayDeque&lt;&gt;();
        Queue&lt;Integer&gt; dq = new ArrayDeque&lt;&gt;();
        seen.add(init);
        q.add(init);
        dq.add(0);
        while (!q.isEmpty()) {
            TreeNode u = q.poll();
            int d = dq.poll();
            if (u.val &gt; 1) {
                --u.val;
                ++init.val;
                dm.total += d;
                return;
            }
            TreeNode[] next = { u.left, u.right, dm.getData(u).parent };
            for (TreeNode v : next) {
                if (v != null &amp;&amp; !seen.contains(v)) {
                    seen.add(v);
                    q.add(v);
                    dq.add(d + 1);
                }
            }
<A NAME="1"></A>        }
    }
    
    private static void dataDfs(TreeNode u, TreeNode p, <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match38-0.html#1',2,'match38-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>DataMap dm) {
        if (u == null) {
            return;
        }
        Data d = dm.getData</B></FONT>(u);
        d.parent = p;
        if (p == null) {
            d.depth = 0;
        } else {
            d.depth = dm.getData(p).depth + 1;
        }
        dataDfs(u.left, u, dm);
        dataDfs(u.right, u, dm);
        d.size = 1 + dm.getData(u.left).size + dm.getData(u.right).size;
        d.valSum = u.val + dm.getData(u.left).valSum + dm.getData(u.right).valSum;
    }
    
    // private int getCoins(Node u) {
    //     if (u == null) {
    //         return 0;
    //     }
<A NAME="0"></A>    //     return u.val;
    // }
    
    <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match38-0.html#0',2,'match38-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>private static class DataMap extends HashMap&lt;TreeNode, Data&gt; {
        public int total;
        
        public Data getData(TreeNode u) {
            if (u == null) {
                return Data.EMPTY;
            }</B></FONT>
            if (containsKey(u)) {
                return get(u);
            }
            Data d = new Data();
            put(u, d);
            return d;
        }
    }
    
    private static class Data {
        public TreeNode parent;
        public int size;
        public int valSum;
        public int depth;
        
        public static final Data EMPTY = new Data();
    }
}
</PRE>

</BODY>
</HTML>
